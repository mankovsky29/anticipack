@page "/support"
@using Microsoft.JSInterop
@using Anticipack.Resources.Localization
@using Anticipack.Components.Shared.NavigationHeaderComponent
@using Microsoft.Extensions.Localization
@using Anticipack.Services
@inject IStringLocalizer<AppResources> L
@inject INavigationHeaderService NavigationHeaderService
@inject IKeyboardService KeyboardService
@implements IAsyncDisposable

<div class="support-container">
    <!-- Contact Info -->
    <div class="contact-info">
        <h3>@L["OtherWaysToReach"]</h3>
        <div class="contact-methods">
            <a href="mailto:support@anticipack.com" class="contact-method">
                <i class="fa fa-envelope"></i>
                <div>
                    <strong>@L["Email"]</strong>
                    <span>support@anticipack.com</span>
                </div>
            </a>
        </div>
    </div>


    <!-- Messages Container -->
    <div class="messages-section">
        <h3>@L["YourMessages"]</h3>
        <div class="messages" @ref="messagesContainer">
            @if (!messages.Any())
            {
                <div class="no-messages">
                    <i class="fa fa-comments"></i>
                    <p>@L["NoMessagesYet"]</p>
                    <p class="hint">@L["SendFirstMessage"]</p>
                </div>
            }
            else
            {
                @foreach (var msg in messages)
                {
                    <div class="message @(msg.IsSent ? "sent" : "received")">
                        <div class="message-avatar">
                            @if (msg.IsSent)
                            {
                                <i class="fa fa-user"></i>
                            }
                            else
                            {
                                <i class="fa fa-headset"></i>
                            }
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="sender-name">@(msg.IsSent ? L["You"] : L["SupportTeam"])</span>
                                <span class="message-time">@msg.Timestamp.ToString("HH:mm")</span>
                            </div>
                            <div class="bubble">@msg.Text</div>
                            @if (msg.Status != MessageStatus.None)
                            {
                                <div class="message-status">
                                    @if (msg.Status == MessageStatus.Sending)
                                    {
                                        <i class="fa fa-circle-notch fa-spin"></i>
                                        <span>@L["Sending"]</span>
                                    }
                                    else if (msg.Status == MessageStatus.Sent)
                                    {
                                        <i class="fa fa-check"></i>
                                        <span>@L["Sent"]</span>
                                    }
                                    else if (msg.Status == MessageStatus.Failed)
                                    {
                                        <i class="fa fa-exclamation-circle"></i>
                                        <span>@L["SendFailed"]</span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Message Input -->
    <div class="message-input-section">
        <div class="input-wrapper">
            <textarea @bind="currentMessage" 
                      @bind:event="oninput" 
                      @ref="messageInput"
                      placeholder="@L["TypeYourMessage"]"
                      rows="1"
                      maxlength="1000"></textarea>
            <div class="input-actions">
                <span class="char-counter">@currentMessage.Length/1000</span>
                <button class="send-btn @(CanSend ? "active" : "disabled")" 
                        @onclick="SendMessage" 
                        disabled="@(!CanSend)"
                        title="@L["Send"]">
                    <i class="fa fa-paper-plane"></i>
                </button>
            </div>
        </div>
        <p class="privacy-notice">
            <i class="fa fa-lock"></i>
            @L["PrivacyNotice"]
        </p>
    </div>
</div>

@code {
[Inject] private IJSRuntime JS { get; set; } = default!;

private ElementReference messageInput;
private ElementReference messagesContainer;
private DotNetObjectReference<Support>? _dotNetRef;

private string currentMessage = string.Empty;
private List<SupportMessage> messages = new();
private bool CanSend => !string.IsNullOrWhiteSpace(currentMessage);
    
// Keyboard
private bool _keyboardVisible;
private double _keyboardHeight;

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        NavigationHeaderService.SetText(L["Support"]);
            
        KeyboardService.Initialize(this);
        KeyboardService.KeyboardVisibilityChanged += OnKeyboardVisibilityChanged;
            
        _dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("supportPage.attach", messageInput, _dotNetRef, messagesContainer);
            
        // Show welcome message
        await Task.Delay(500);
        messages.Add(new SupportMessage
        {
            Text = L["WelcomeToSupport"],
            Timestamp = DateTime.Now,
            IsSent = false,
            Status = MessageStatus.None
        });
        StateHasChanged();
        await ScrollToBottom();
    }
}
    
    private void OnKeyboardVisibilityChanged(bool isVisible, double height)
    {
        _keyboardVisible = isVisible;
        _keyboardHeight = height;

        if (isVisible)
        {
            // Adjust page padding to account for keyboard height
            _ = JS.InvokeVoidAsync("adjustPageForKeyboard", height);
            
            // Scroll the active input into view to ensure it's not covered by the keyboard
            _ = JS.InvokeVoidAsync("scrollActiveElementIntoView");
        }
        else
        {
            // Remove padding when keyboard hides
            _ = JS.InvokeVoidAsync("adjustPageForKeyboard", 0);
        }
    }

    private async Task SendMessage()
    {
        var text = currentMessage?.Trim();
        if (string.IsNullOrWhiteSpace(text))
            return;

        var message = new SupportMessage
        {
            Text = text,
            Timestamp = DateTime.Now,
            IsSent = true,
            Status = MessageStatus.Sending
        };

        messages.Add(message);
        currentMessage = string.Empty;
        StateHasChanged();
        await ScrollToBottom();

        // Simulate sending to support
        await Task.Delay(1500);
        message.Status = MessageStatus.Sent;
        StateHasChanged();

        // Simulate auto-response after a delay
        await Task.Delay(2000);
        messages.Add(new SupportMessage
        {
            Text = L["AutoReplyMessage"],
            Timestamp = DateTime.Now,
            IsSent = false,
            Status = MessageStatus.None
        });
        StateHasChanged();
        await ScrollToBottom();
    }

    [JSInvokable]
    public Task SubmitFromJs() => SendMessage();

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("supportPage.scrollToBottom", messagesContainer);
        }
        catch
        {
            // Ignore if JS not ready
        }
    }

    public async ValueTask DisposeAsync()
    {
        KeyboardService.KeyboardVisibilityChanged -= OnKeyboardVisibilityChanged;
        
        if (_dotNetRef is not null)
        {
            _dotNetRef.Dispose();
            _dotNetRef = null;
        }

        try
        {
            await JS.InvokeVoidAsync("supportPage.detach", messageInput);
        }
        catch
        {
            // ignore if JS side not present
        }
    }

    private enum MessageStatus
    {
        None,
        Sending,
        Sent,
        Failed
    }

    private sealed class SupportMessage
    {
        public string Text { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public bool IsSent { get; set; }
        public MessageStatus Status { get; set; } = MessageStatus.None;
    }
}

<script>
    window.supportPage = {
        attach: function (inputEl, dotNetRef, messagesEl) {
            if (!inputEl) return;
            
            // Auto-resize textarea
            const autoResize = function() {
                inputEl.style.height = 'auto';
                inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
            };
            
            const keydownHandler = function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    dotNetRef.invokeMethodAsync('SubmitFromJs');
                }
            };
            
            inputEl.__supportAutoResize = autoResize;
            inputEl.__supportKeydownHandler = keydownHandler;
            inputEl.addEventListener('input', autoResize);
            inputEl.addEventListener('keydown', keydownHandler);
            inputEl.__messagesEl = messagesEl;
        },
        
        detach: function (inputEl) {
            if (!inputEl) return;
            if (inputEl.__supportAutoResize) {
                inputEl.removeEventListener('input', inputEl.__supportAutoResize);
                delete inputEl.__supportAutoResize;
            }
            if (inputEl.__supportKeydownHandler) {
                inputEl.removeEventListener('keydown', inputEl.__supportKeydownHandler);
                delete inputEl.__supportKeydownHandler;
            }
            delete inputEl.__messagesEl;
        },
        
        scrollToBottom: function (messagesEl) {
            try {
                if (!messagesEl) return;
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } catch (e) {
                // ignore
            }
        }
    };
</script>
